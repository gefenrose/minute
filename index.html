<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>×“×§×” ×‘×™×•× ğŸŒ¿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* BASE STYLES */
body{margin:0;padding:12px;min-height:100vh;font-family:'Segoe UI',sans-serif;background:#fefcf5;display:flex;justify-content:center;color:#3e2723;}
.card{background:#fff;border-radius:22px;padding:20px;width:90%;max-width:420px;margin:10px auto;box-shadow:0 8px 24px rgba(0,0,0,.08);transition:opacity 0.4s, transform 0.4s;}
.card.hidden{opacity:0;transform:translateY(20px);pointer-events:none;}
h1{font-size:clamp(20px,5vw,32px);text-align:center;color:#33691e;margin:6px 0 12px;}
h2{font-size:clamp(18px,4vw,28px);text-align:center;color:#33691e;margin:6px 0 12px;}
textarea{width:100%;min-height:90px;padding:14px;border-radius:16px;border:1px solid #c7b8a6;background:#fcf9f0;font-size:clamp(14px,2.5vw,18px);}
.mood-section{margin:14px 0;}
.mood-title{font-size:14px;color:#6d4c41;margin-bottom:8px;}
.mood-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(40px,1fr));gap:10px;}
.mood-btn{font-size:26px;padding:10px 0;border-radius:14px;background:#f7f5ee;border:1px solid transparent;cursor:pointer;}
.mood-btn.active{background:#e8f5e9;border-color:#558b2f;transform:scale(1.1);}
button{width:100%;padding:calc(12px + 0.5vw);margin-top:12px;border:none;border-radius:16px;background:#558b2f;color:#fff;font-size:clamp(12px,2.5vw,16px);}
.link{text-align:center;margin-top:12px;color:#558b2f;cursor:pointer;font-size:clamp(12px,2.5vw,16px);}
.search{width:100%;padding:calc(10px + 0.5vw);border-radius:14px;border:1px solid #c7b8a6;margin-bottom:10px;font-size:clamp(12px,2.5vw,16px);}
.month{margin-bottom:12px;border-radius:16px;background:#f7f5ee;overflow:hidden;}
.month-header{padding:calc(10px + 0.5vw);font-weight:600;cursor:pointer;font-size:clamp(12px,2.5vw,16px);}
.entry{padding:10px;border-top:1px solid #e0d7cc;}
.entry-header{display:flex;justify-content:space-between;align-items:center;}
.entry-date{font-size:clamp(10px,2vw,14px);color:#8d6e63;}
.entry-mood{font-size:clamp(10px,2vw,14px);}
.actions{display:flex;gap:10px;font-size:clamp(12px,2vw,14px);color:#558b2f;}
.undo{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#558b2f;color:#fff;padding:12px 20px;border-radius:16px;display:flex;gap:12px;align-items:center;}
.chart{display:flex;justify-content:space-between;flex-wrap:wrap;margin-top:12px;}
.bar{flex:1;height:20px;margin:2px 1px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:clamp(10px,2vw,14px);color:#fff;transition: all 0.5s ease;}
.bar.ğŸ˜Š{background:#81c784;} .bar.ğŸ˜Œ{background:#aed581;} .bar.ğŸ˜”{background:#4db6ac;}
.bar.ğŸ˜¡{background:#e57373;} .bar.ğŸ˜{background:#64b5f6;} .bar.ğŸ¥°{background:#f06292;}
.bar.ğŸ˜´{background:#90a4ae;} .bar.ğŸ˜•{background:#ffd54f;} .bar.ğŸŒ¿{background:#a5d6a7;} .bar.âœ¨{background:#ffb74d;}
#lineChart{width:100%;height:120px;margin-top:16px;position:relative;}
.line{stroke:#558b2f;stroke-width:3;fill:none;transition: stroke-dashoffset 0.6s ease;}
.dot{fill:#33691e;transition:r 0.3s ease;}
</style>
</head>

<body>

<!-- JOURNAL -->
<div id="journal" class="card">
  <h1>×“×§×” ×‘×™×•× ğŸŒ¿</h1>
  <textarea id="entry" placeholder="××©×¤×˜ ××—×“ ×¢×œ ×”×™×•×â€¦"></textarea>
  <div class="mood-section">
    <div class="mood-title">××™×š ×”×¨×’×©×ª ×”×™×•×?</div>
    <div id="moodGrid" class="mood-grid"></div>
  </div>
  <button onclick="save()">×©××•×¨</button>
  <div class="link" onclick="openHistory()">ğŸ“– ×”×™×¡×˜×•×¨×™×”</div>
  <div class="link" onclick="openStats()">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×” ×—×•×“×©×™×ª</div>
</div>

<!-- HISTORY -->
<div id="history" class="card hidden">
  <h2>×”×™×¡×˜×•×¨×™×” ğŸŒ¿</h2>
  <input id="search" class="search" placeholder="×—×™×¤×•×©â€¦" oninput="renderHistory()">
  <div id="list"></div>
  <div class="link" onclick="back()">â¬… ×—×–×¨×”</div>
</div>

<!-- STATS -->
<div id="stats" class="card hidden">
  <h2>×¡×˜×˜×™×¡×˜×™×§×ª ×¨×’×©×•×ª ğŸŒ¿</h2>
  <select id="monthSelect" onchange="renderStats()"></select>
  <div id="chart" class="chart"></div>
  <svg id="lineChart"></svg>
  <button onclick="exportPDF()">ğŸ“ ×™×™×¦×•× PDF</button>
  <div class="link" onclick="back()">â¬… ×—×–×¨×”</div>
</div>

<div id="undoBox" class="undo hidden">
  <span>× ××—×§ ğŸŒ¿</span>
  <button onclick="undoDelete()">×‘×™×˜×•×œ</button>
</div>

<script>
const PREFIX="minute-";
const MOODS=["ğŸ˜Š","ğŸ˜Œ","ğŸ˜”","ğŸ˜¡","ğŸ˜","ğŸ¥°","ğŸ˜´","ğŸ˜•","ğŸŒ¿","âœ¨"];
let selectedMood="", editingDate=null, deletedEntry=null;

/* MOOD GRID */
const grid=document.getElementById("moodGrid");
MOODS.forEach(m=>{
  const b=document.createElement("button"); b.className="mood-btn"; b.textContent=m;
  b.onclick=()=>{
    selectedMood=m; document.querySelectorAll(".mood-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
  }; grid.appendChild(b);
});

/* SAVE */
function save(){
  const date=editingDate||new Date().toISOString().slice(0,10);
  localStorage.setItem(PREFIX+date,JSON.stringify({text:entry.value.trim(),mood:selectedMood}));
  editingDate=null; entry.value=""; selectedMood="";
  document.querySelectorAll(".mood-btn").forEach(x=>x.classList.remove("active"));
  alert("× ×©××¨ ğŸŒ¿");
}

/* NAV */
function openHistory(){renderHistory();toggle("history");}
function openStats(){populateMonths();renderStats();toggle("stats");}
function back(){toggle("journal");}
function toggle(id){
  journal.classList.add("hidden"); history.classList.add("hidden"); stats.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

/* HISTORY */
function renderHistory(){
  const q=search.value.toLowerCase();
  list.innerHTML=""; const byMonth={};
  Object.keys(localStorage).filter(k=>k.startsWith(PREFIX)).forEach(k=>{
    const date=k.replace(PREFIX,""); const month=date.slice(0,7);
    byMonth[month]=byMonth[month]||[];
    byMonth[month].push({date,...JSON.parse(localStorage[k])});
  });
  Object.keys(byMonth).sort().reverse().forEach(month=>{
    const m=document.createElement("div"); m.className="month";
    const h=document.createElement("div"); h.className="month-header"; h.textContent=month;
    const c=document.createElement("div"); h.onclick=()=>c.classList.toggle("hidden");
    byMonth[month].sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
      if(q && !e.text.toLowerCase().includes(q) && !e.mood.includes(q)) return;
      const d=document.createElement("div"); d.className="entry";
      d.innerHTML=`
        <div class="entry-header">
          <div>
            <div class="entry-date">${e.date}</div>
            <div class="entry-mood">${e.mood||""}</div>
          </div>
          <div class="actions">
            <span onclick="editEntry('${e.date}')">âœï¸</span>
            <span onclick="deleteEntry('${e.date}')">ğŸ—‘ï¸</span>
          </div>
        </div>
        <div>${e.text}</div>
      `;
      c.appendChild(d);
    });
    if(c.children.length){m.append(h,c);list.appendChild(m);}
  });
  if(!list.innerHTML) list.innerHTML="<div style='text-align:center;color:#8d6e63;'>××™×Ÿ ×ª×•×¦××•×ª</div>";
}

/* EDIT */
function editEntry(date){
  const d=JSON.parse(localStorage.getItem(PREFIX+date));
  editingDate=date; entry.value=d.text; selectedMood=d.mood;
  document.querySelectorAll(".mood-btn").forEach(b=>b.classList.toggle("active",b.textContent===selectedMood));
  toggle("journal");
}

/* DELETE + UNDO */
function deleteEntry(date){
  deletedEntry={key:PREFIX+date,value:localStorage.getItem(PREFIX+date)};
  localStorage.removeItem(PREFIX+date); renderHistory();
  const undoBox=document.getElementById("undoBox"); undoBox.classList.remove("hidden");
  setTimeout(()=>undoBox.classList.add("hidden"),5000);
}
function undoDelete(){if(deletedEntry) localStorage.setItem(deletedEntry.key,deletedEntry.value); deletedEntry=null; renderHistory(); document.getElementById("undoBox").classList.add("hidden");}

/* STATS */
function populateMonths(){
  const sel=document.getElementById("monthSelect"); sel.innerHTML="";
  const months=new Set(Object.keys(localStorage).filter(k=>k.startsWith(PREFIX)).map(k=>k.replace(PREFIX,"").slice(0,7)));
  Array.from(months).sort().forEach(m=>{const o=document.createElement("option"); o.value=m; o.textContent=m; sel.appendChild(o);});
}
function renderStats(){
  // Bar chart
  const month=document.getElementById("monthSelect").value;
  const chart=document.getElementById("chart"); chart.innerHTML="";
  const counts={}; MOODS.forEach(m=>counts[m]=0);
  Object.keys(localStorage).filter(k=>k.startsWith(PREFIX) && k.includes(month)).forEach(k=>{
    const d=JSON.parse(localStorage[k]); if(d.mood && counts[d.mood]!==undefined) counts[d.mood]++;
  });
  const max=Math.max(...Object.values(counts),1);
  MOODS.forEach(m=>{
    const b=document.createElement("div"); b.className="bar "+m; b.style.flex="0"; b.textContent=counts[m]>0?m:""; chart.appendChild(b);
    setTimeout(()=>b.style.flex=counts[m]/max,50);
  });
  renderWeeklyChart();
}

/* WEEKLY LINE CHART */
function renderWeeklyChart(){
  const svg=document.getElementById("lineChart"); svg.innerHTML="";
  const days=7, values=[];
  for(let i=0;i<days;i++){
    const date=new Date(); date.setDate(date.getDate()-i);
    const key=PREFIX+date.toISOString().slice(0,10);
    const e=localStorage.getItem(key);
    values.unshift(e?MOODS.indexOf(JSON.parse(e).mood)+1 || 0 :0);
  }
  const w=svg.clientWidth, h=svg.clientHeight, maxVal=Math.max(...values,1);
  let path=""; values.forEach((v,i)=>{const x=i*(w/(days-1)); const y=h-(v/maxVal)*h; path+=i===0?`M${x},${y}`:` L${x},${y}`;});
  const line=document.createElementNS("http://www.w3.org/2000/svg","path");
  line.setAttribute("d",path); line.setAttribute("class","line");
  line.setAttribute("stroke-dasharray",line.getTotalLength());
  line.setAttribute("stroke-dashoffset",line.getTotalLength());
  svg.appendChild(line); setTimeout(()=>line.setAttribute("stroke-dashoffset",0),50);
  values.forEach((v,i)=>{const x=i*(w/(days-1)), y=h-(v/maxVal)*h; const dot=document.createElementNS("http://www.w3.org/2000/svg","circle"); dot.setAttribute("cx",x); dot.setAttribute("cy",y); dot.setAttribute("r",v?4:0); dot.setAttribute("class","dot"); svg.appendChild(dot);});
}

/* EXPORT PDF */
function exportPDF(){
  const month=document.getElementById("monthSelect").value;
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  doc.setFontSize(16); doc.text(`×¡×˜×˜×™×¡×˜×™×§×ª ×¨×’×©×•×ª - ${month}`,14,20);
  const yStart=30, chartData=document.getElementById("chart").children;
  let x=14;
  Array.from(chartData).forEach(b=>{
    const w=20, h=50*(b.style.flex||0);
    const bg=window.getComputedStyle(b).backgroundColor;
    doc.setFillColor(bg); doc.rect(x,yStart,w,h,'F'); doc.setTextColor(0,0,0); doc.text(b.textContent||'',x+6,yStart+h+6); x+=w+4;
  });
  doc.save(`×¡×˜×˜×™×¡×˜×™×§×”_${month}.pdf`);
}
</script>

</body>
</html>
