<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>×“×§×” ×‘×™×•× ğŸŒ¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#f06292">
<style>
body {font-family:'Segoe UI',sans-serif;margin:0;padding:16px;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;background:linear-gradient(135deg,#fff5f7,#ffe6f0);}
.hidden{display:none;}
.card{background:#fff0f6;border-radius:28px;padding:24px;width:100%;max-width:480px;margin:20px 0;box-shadow:0 12px 32px rgba(0,0,0,0.08);position:relative;z-index:1;transition:transform 0.25s ease,box-shadow 0.25s ease,opacity 0.5s;}
.card.fade-in{opacity:1;animation:fadeIn 0.5s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);}}
h1,h2{text-align:center;margin-top:0;color:#f06292;font-weight:700;}
textarea{width:100%;padding:14px;border-radius:20px;border:1px solid #f8c1d1;font-size:16px;background:#fff0f6;resize:none;min-height:80px;transition:border 0.2s ease,box-shadow 0.2s ease;}
textarea:focus{border-color:#f06292;box-shadow:0 0 12px rgba(240,98,146,0.25);outline:none;}
button{width:100%;padding:14px;border-radius:20px;border:none;background:#f06292;color:white;font-size:16px;margin-top:10px;cursor:pointer;transition:background 0.2s ease,transform 0.1s ease;}
button:hover{background:#e91e63;} button:active{transform:scale(0.97);}
.link{text-align:center;margin-top:12px;color:#f06292;cursor:pointer;font-weight:500;display:block;}
.entry{border-bottom:1px solid #fcd8e3;padding:10px 0;}
.date{font-size:13px;color:#c2185b;margin-bottom:4px;}
.entry img{max-width:100%;border-radius:14px;margin-top:6px;}
.flower::before{content:"ğŸŒ¸ ";font-size:18px;margin-right:2px;}
#emojiPicker{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;}
.emoji-btn{font-size:20px;cursor:pointer;padding:4px;border:none;background:transparent;}
#moodPicker{display:flex;gap:8px;margin:12px 0;justify-content:center;}
.mood-btn{font-size:28px;cursor:pointer;padding:6px;border-radius:14px;transition:transform 0.2s ease;}
.mood-btn:hover{transform:scale(1.3);}
.drag-hover{border:2px dashed #f06292;}
.emoji-fly{position:absolute;animation:flyEmoji 1s ease forwards;}
@keyframes flyEmoji{0%{opacity:1;transform:translateY(0) scale(1);}50%{opacity:1;transform:translateY(-50px) scale(1.5);}100%{opacity:0;transform:translateY(-80px) scale(0.5);}}
</style>
</head>
<body>

<!-- ğŸ”’ LOCK -->
<div id="lock" class="card fade-in">
  <h1>ğŸ” ×›× ×™×¡×” ×‘×™×•××˜×¨×™×ª ğŸŒº</h1>
  <button onclick="authenticateBiometric()">×”×ª×—×‘×¨ ğŸŒ¸</button>
</div>

<!-- âœï¸ JOURNAL -->
<div id="journal" class="card hidden">
  <h1>×“×§×” ×‘×™×•× ğŸŒ¸</h1>
  <div id="todayDate" class="date flower"></div>

  <!-- ×˜×§×¡×˜ -->
  <textarea id="entry" maxlength="280" placeholder="××©×¤×˜ ××—×“ ×¢×œ ×”×™×•×â€¦ ğŸ˜Š"></textarea>

  <!-- Emoji Picker -->
  <div id="emojiPicker"></div>

  <!-- ×™×•××Ÿ ×¨×’×©×•×ª -->
  <div id="moodPicker"></div>

  <!-- ×ª××•× ×•×ª -->
  <input type="file" id="imageInput" accept="image/*">
  <button onclick="addImage()">×”×•×¡×£ ×ª××•× ×” ğŸŒ¼</button>

  <!-- ×©××™×¨×” -->
  <button onclick="saveEntry()">×©××•×¨ ğŸ’¾</button>
  <div class="link" onclick="openHistory()">ğŸ“– ×”×™×¡×˜×•×¨×™×”</div>
  <div class="link" onclick="lockApp()">ğŸ”’ × ×¢×™×œ×”</div>
</div>

<!-- ğŸ“– HISTORY -->
<div id="history" class="card hidden">
  <h2>×”×™×¡×˜×•×¨×™×” ğŸŒ¸</h2>
  <input id="search" placeholder="×—×™×¤×•×©... ğŸ”" oninput="renderHistory()" style="padding:10px;border-radius:14px;border:1px solid #f8c1d1;width:100%;margin-bottom:10px;">
  <div id="list"></div>
  <div class="link" onclick="backToJournal()">â¬… ×—×–×¨×”</div>
</div>

<script>
const PREFIX="minute-";
const AUTH_KEY="webauthn-id";
const KEY_KEY="minute-key";
let cryptoKey=null;
let images=[];
let mood="";

// --- ×ª××¨×™×š ×”×™×•× ---
const today=new Date().toISOString().slice(0,10);
document.getElementById("todayDate").textContent=
new Date().toLocaleDateString("he-IL",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

/* ---------------- CRYPTO ---------------- */
async function generateRandomKey(){ return crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"]); }
async function exportCryptoKey(key){ const raw=await crypto.subtle.exportKey("raw",key); return btoa(String.fromCharCode(...new Uint8Array(raw))); }
async function importCryptoKey(str){ const raw=Uint8Array.from(atob(str),c=>c.charCodeAt(0)); return crypto.subtle.importKey("raw",raw,{name:"AES-GCM"},true,["encrypt","decrypt"]); }
async function encrypt(text){ const iv=crypto.getRandomValues(new Uint8Array(12)); const enc=new TextEncoder(); const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},cryptoKey,enc.encode(text)); return btoa(String.fromCharCode(...iv))+":"+btoa(String.fromCharCode(...new Uint8Array(ct))); }
async function decrypt(cipher){ const [iv64,ct64]=cipher.split(":"); const iv=Uint8Array.from(atob(iv64),c=>c.charCodeAt(0)); const ct=Uint8Array.from(atob(ct64),c=>c.charCodeAt(0)); const plain=await crypto.subtle.decrypt({name:"AES-GCM",iv},cryptoKey,ct); return new TextDecoder().decode(plain); }

/* ---------------- BIOMETRIC ---------------- */
async function authenticateBiometric(){
  if(!window.PublicKeyCredential){ alert("×”××›×©×™×¨ ×œ× ×ª×•××š ×‘×™×•××˜×¨×™×”"); return; }
  try{
    if(!localStorage.getItem(AUTH_KEY)){
      const cred=await navigator.credentials.create({publicKey:{
        challenge:crypto.getRandomValues(new Uint8Array(32)),
        rp:{name:"Minute Journal"},
        user:{id:crypto.getRandomValues(new Uint8Array(16)),name:"user",displayName:"User"},
        pubKeyCredParams:[{type:"public-key",alg:-7}],
        authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required"},
        timeout:60000
      }});
      localStorage.setItem(AUTH_KEY,btoa(String.fromCharCode(...new Uint8Array(cred.rawId))));
      const key=await generateRandomKey();
      cryptoKey=key;
      localStorage.setItem(KEY_KEY,await exportCryptoKey(key));
    } else {
      const rawId=Uint8Array.from(atob(localStorage.getItem(AUTH_KEY)),c=>c.charCodeAt(0));
      await navigator.credentials.get({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),allowCredentials:[{id:rawId,type:"public-key"}],userVerification:"required",timeout:60000}});
      cryptoKey=await importCryptoKey(localStorage.getItem(KEY_KEY));
    }
    await loadEntry();
    show("journal");
  } catch(e){ alert("××™××•×ª × ×›×©×œ, × ×¡×” ×©×•×‘"); }
}

/* ---------------- JOURNAL ---------------- */
async function loadEntry(){
  const stored=localStorage.getItem(PREFIX+today);
  if(stored){
    const data=JSON.parse(await decrypt(stored));
    document.getElementById("entry").value=data.text||"";
    images=data.images||[];
    mood=data.mood||"";
    highlightMood();
  } else { document.getElementById("entry").value=""; images=[]; mood=""; }
}
async function saveEntry(){
  const data={text:document.getElementById("entry").value, images, mood};
  const enc=await encrypt(JSON.stringify(data));
  localStorage.setItem(PREFIX+today,enc);
  alert("× ×©××¨ ğŸ’–");
}

/* ---------------- IMAGES ---------------- */
function addImage(){
  const file=document.getElementById("imageInput").files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    images.push(e.target.result);
    flyEmoji("ğŸŒ¼");
    alert("×ª××•× ×” × ×•×¡×¤×” ğŸŒ¼");
  };
  reader.readAsDataURL(file);
}

/* ---------------- HISTORY ---------------- */
function openHistory(){ renderHistory(); show("history"); }
async function renderHistory(){
  const q=document.getElementById("search").value.toLowerCase();
  const list=document.getElementById("list");
  list.innerHTML="";
  const keys=Object.keys(localStorage).filter(k=>k.startsWith(PREFIX)).sort().reverse();
  for(const k of keys){
    try{
      const data=JSON.parse(await decrypt(localStorage.getItem(k)));
      if(!data.text.toLowerCase().includes(q)) continue;
      const div=document.createElement("div"); div.className="entry";
      let html=`<div class="date flower">${k.replace(PREFIX,"")}</div><div>${data.text}</div>`;
      if(data.mood) html+=`<div style="font-size:24px;">××¦×‘ ×¨×•×—: ${data.mood}</div>`;
      if(data.images) data.images.forEach(img=>{html+=`<img src="${img}"/>`;});
      div.innerHTML=html;
      list.appendChild(div);
    }catch(e){ continue; }
  }
}
function backToJournal(){ show("journal"); }

/* ---------------- EMOJI PICKER ---------------- */
const emojiList=["ğŸ˜Š","ğŸ˜‚","ğŸ˜","ğŸ¥°","ğŸ˜","ğŸŒ¸","ğŸŒ¼","ğŸŒº","ğŸ’–","âœ¨"];
const picker=document.getElementById("emojiPicker");
emojiList.forEach(e=>{
  const btn=document.createElement("button"); btn.className="emoji-btn"; btn.textContent=e;
  btn.onclick=()=>{ document.getElementById("entry").value += e; flyEmoji(e); };
  picker.appendChild(btn);
});

/* ---------------- MOOD PICKER ---------------- */
const moods=["ğŸ˜Š","ğŸ˜”","ğŸ˜¡","ğŸ˜","ğŸ¥°","ğŸ˜´"];
const moodContainer=document.getElementById("moodPicker");
moods.forEach(m=>{
  const btn=document.createElement("button"); btn.className="mood-btn"; btn.textContent=m;
  btn.onclick=()=>{ mood=m; highlightMood(); flyEmoji(m); };
  moodContainer.appendChild(btn);
});
function highlightMood(){ moodContainer.querySelectorAll("button").forEach(b=>b.style.transform=b.textContent===mood?"scale(1.5)":"scale(1)"); }

/* ---------------- FLYING EMOJI ANIMATION ---------------- */
function flyEmoji(e){
  const span=document.createElement("span");
  span.className="emoji-fly"; span.textContent=e;
  document.body.appendChild(span);
  const x=Math.random()*(window.innerWidth-50);
  span.style.left=x+"px"; span.style.top=(window.innerHeight-100)+"px";
  setTimeout(()=>span.remove(),1000);
}

/* ---------------- NAV ---------------- */
function show(id){["lock","journal","history"].forEach(x=>{const el=document.getElementById(x);el.classList.add("hidden");el.classList.remove("fade-in");}); const el=document.getElementById(id);el.classList.remove("hidden");el.classList.add("fade-in");}
</script>
</body>
</html>