<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>×“×§×” ×‘×™×•×</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: system-ui,sans-serif; background:#f5f5f5; margin:0; padding:16px;}
.hidden{display:none;}
.card{background:#fff;border-radius:16px;padding:16px;max-width:480px;margin:auto;box-shadow:0 10px 25px rgba(0,0,0,0.08);}
h1,h2{text-align:center;margin-top:0;}
textarea,input{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc;font-size:16px;box-sizing:border-box;margin-bottom:10px;}
button{width:100%;padding:10px;border-radius:12px;border:none;background:#000;color:#fff;font-size:16px;margin-top:8px;}
.link{text-align:center;margin-top:10px;color:#007aff;cursor:pointer;}
.entry{border-bottom:1px solid #eee;padding:8px 0;}
.date{font-size:13px;color:#666;}
</style>
</head>
<body>

<!-- ğŸ”’ LOCK -->
<div id="lock" class="card">
  <h1>ğŸ” ××™××•×ª</h1>
  <button onclick="authenticate()">×›× ×™×¡×” ×‘×™×•××˜×¨×™×ª</button>
  <div style="margin-top:10px;text-align:center;">××• ×”×©×ª××© ×‘×§×•×“ PIN</div>
  <input id="pinInput" type="password" placeholder="×”×–×Ÿ PIN" />
  <button onclick="pinLogin()">×›× ×™×¡×” ×¢× PIN</button>
</div>

<!-- âœï¸ JOURNAL -->
<div id="journal" class="card hidden">
  <h1>×“×§×” ×‘×™×•×</h1>
  <div id="todayDate" class="date"></div>
  <textarea id="entry" maxlength="280" placeholder="××©×¤×˜ ××—×“ ×¢×œ ×”×™×•×â€¦"></textarea>
  <button onclick="save()">×©××™×¨×”</button>
  <div class="link" onclick="openHistory()">ğŸ“– ×”×™×¡×˜×•×¨×™×”</div>
  <div class="link" onclick="lockApp()">ğŸ”’ × ×¢×™×œ×”</div>
</div>

<!-- ğŸ“– HISTORY -->
<div id="history" class="card hidden">
  <h2>×”×™×¡×˜×•×¨×™×”</h2>
  <input id="search" placeholder="×—×™×¤×•×©..." oninput="renderHistory()">
  <div id="list"></div>
  <div class="link" onclick="back()">â¬… ×—×–×¨×”</div>
</div>

<script>
const PREFIX="minute-";
const AUTH_KEY="webauthn-id";
const PIN_KEY="minute-pin";
let cryptoKey=null;
const today=new Date().toISOString().slice(0,10);
document.getElementById("todayDate").textContent=
new Date().toLocaleDateString("he-IL",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

async function deriveKey(pin) {
  const enc = new TextEncoder();
  const keyMaterial = await window.crypto.subtle.importKey(
    "raw", enc.encode(pin), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2",salt:enc.encode("minute-journal"),iterations:100000,hash:"SHA-256"},
    keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]
  );
}

async function encrypt(text) {
  const iv=window.crypto.getRandomValues(new Uint8Array(12));
  const enc= new TextEncoder();
  const ct = await window.crypto.subtle.encrypt({name:"AES-GCM",iv}, cryptoKey, enc.encode(text));
  return btoa(String.fromCharCode(...iv)) + ":" + btoa(String.fromCharCode(...new Uint8Array(ct)));
}

async function decrypt(ciphertext) {
  const [iv64, ct64]=ciphertext.split(":");
  const iv=Uint8Array.from(atob(iv64),c=>c.charCodeAt(0));
  const ct=Uint8Array.from(atob(ct64),c=>c.charCodeAt(0));
  const plain = await window.crypto.subtle.decrypt({name:"AES-GCM",iv},cryptoKey,ct);
  return new TextDecoder().decode(plain);
}

/* ---------- BIOMETRIC ---------- */
async function authenticate() {
  if (!window.PublicKeyCredential) { alert("×œ× ×ª×•××š ×‘×™×•××˜×¨×™"); return; }
  try {
    if (!localStorage.getItem(AUTH_KEY)) {
      const cred=await navigator.credentials.create({publicKey:{
        challenge:crypto.getRandomValues(new Uint8Array(32)),
        rp:{name:"Minute Journal"},
        user:{id:crypto.getRandomValues(new Uint8Array(16)),name:"user",displayName:"User"},
        pubKeyCredParams:[{type:"public-key",alg:-7}],
        authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required"},
        timeout:60000
      }});
      localStorage.setItem(AUTH_KEY,btoa(String.fromCharCode(...new Uint8Array(cred.rawId))));
    }
    const rawId=Uint8Array.from(atob(localStorage.getItem(AUTH_KEY)),c=>c.charCodeAt(0));
    await navigator.credentials.get({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),allowCredentials:[{id:rawId,type:"public-key"}],userVerification:"required",timeout:60000}});
    const pin = prompt("×§×‘×¢ PIN ×—×“×© (4 ×¡×¤×¨×•×ª) ×œ×”×¦×¤× ×”");
    cryptoKey=await deriveKey(pin);
    localStorage.setItem(PIN_KEY,btoa(pin));
    await loadEntry();
    show("journal");
  } catch(e){ alert("×›×©×œ ×‘×™×•××˜×¨×™, ×”×©×ª××© ×‘-PIN"); }
}

/* ---------- POLLBACK PIN ---------- */
async function pinLogin() {
  const pin=document.getElementById("pinInput").value;
  if(!pin || !localStorage.getItem(PIN_KEY)) { alert("PIN ×œ× ×ª×§×™×Ÿ"); return; }
  cryptoKey=await deriveKey(pin);
  try { await loadEntry(); show("journal"); }
  catch(e){ alert("×›× ×™×¡×” × ×›×©×œ×”, PIN ×©×’×•×™ ××• ×ª×•×›×Ÿ ×¤×’×•×"); }
}

/* ---------- JOURNAL ---------- */
async function loadEntry() {
  const stored = localStorage.getItem(PREFIX+today);
  if(stored) document.getElementById("entry").value = await decrypt(stored);
  else document.getElementById("entry").value="";
}

async function save() {
  const text=document.getElementById("entry").value;
  const enc=await encrypt(text);
  localStorage.setItem(PREFIX+today,enc);
  alert("× ×©××¨ âœ“");
}

function lockApp() { show("lock"); }

/* ---------- HISTORY ---------- */
function openHistory(){ renderHistory(); show("history"); }
async function renderHistory(){
  const q=document.getElementById("search").value.toLowerCase();
  const list=document.getElementById("list");
  list.innerHTML="";
  const keys=Object.keys(localStorage).filter(k=>k.startsWith(PREFIX)).sort().reverse();
  for(const k of keys){
    try{
      const text=await decrypt(localStorage.getItem(k));
      if(!text.toLowerCase().includes(q)) continue;
      const div=document.createElement("div"); div.className="entry";
      div.innerHTML=`<div class="date">${k.replace(PREFIX,"")}</div><div>${text}</div>`;
      list.appendChild(div);
    } catch(e){ continue; }
  }
}

function back(){ show("journal"); }
function show(id){ ["lock","journal","history"].forEach(x=>document.getElementById(x).classList.add("hidden")); document.getElementById(id).classList.remove("hidden"); }
</script>
</body>
</html>