<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>×“×§×” ×‘×™×•×</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#42a5f5">
<style>
body { font-family: system-ui,sans-serif; background: linear-gradient(to bottom right,#f0f4f8,#e3f2fd); margin:0; padding:16px; }
.hidden{display:none;}
.card{background: linear-gradient(145deg,#ffffff,#f9fafe); border-radius:20px; padding:20px; max-width:480px; margin:20px auto; box-shadow:0 8px 20px rgba(0,0,0,0.08); transition: transform 0.2s ease, box-shadow 0.2s ease;}
.card:hover{transform: translateY(-3px); box-shadow:0 12px 25px rgba(0,0,0,0.12);}
h1,h2{text-align:center;margin-top:0; color:#0d47a1;}
textarea,input{width:100%; padding:12px; border-radius:14px; border:1px solid #cfd8dc; font-size:16px; box-sizing:border-box; margin-bottom:12px; background:#f0f4f8; transition:border-color 0.2s ease, box-shadow 0.2s ease;}
textarea:focus,input:focus{border-color:#42a5f5; box-shadow:0 0 8px rgba(66,165,245,0.3); outline:none;}
button{width:100%; padding:12px; border-radius:14px; border:none; background:#42a5f5; color:white; font-size:16px; margin-top:6px; cursor:pointer; transition: background 0.2s ease, transform 0.1s ease;}
button:hover{background:#1e88e5;} button:active{transform:scale(0.97);}
.link{text-align:center; margin-top:10px; color:#1e88e5; cursor:pointer; font-weight:500;}
.entry{border-bottom:1px solid #e0e0e0; padding:8px 0;}
.date{font-size:13px; color:#78909c;}
</style>
</head>
<body>

<!-- ğŸ”’ LOCK -->
<div id="lock" class="card">
  <h1>ğŸ” ×›× ×™×¡×” ×‘×™×•××˜×¨×™×ª</h1>
  <button onclick="authenticateBiometric()">×›× ×™×¡×” ×‘×™×•××˜×¨×™×ª</button>
  <div style="margin-top:10px;text-align:center;">××• fallback ×¢× PIN</div>
  <input id="pinInput" type="password" placeholder="×”×–×Ÿ PIN">
  <button onclick="fallbackPin()">×›× ×™×¡×” ×¢× PIN</button>
</div>

<!-- âœï¸ JOURNAL -->
<div id="journal" class="card hidden">
  <h1>×“×§×” ×‘×™×•×</h1>
  <div id="todayDate" class="date"></div>
  <textarea id="entry" maxlength="280" placeholder="××©×¤×˜ ××—×“ ×¢×œ ×”×™×•×â€¦"></textarea>
  <button onclick="saveEntry()">×©××™×¨×”</button>
  <div class="link" onclick="openHistory()">ğŸ“– ×”×™×¡×˜×•×¨×™×”</div>
  <div class="link" onclick="lockApp()">ğŸ”’ × ×¢×™×œ×”</div>
  <div class="link" onclick="exportJournal()">â¬‡ ×™×™×¦×•× ×™×•××Ÿ</div>
  <input type="file" id="importFile" style="display:none;" onchange="importJournal(event)">
  <div class="link" onclick="document.getElementById('importFile').click()">â¬† ×™×™×‘×•× ×™×•××Ÿ</div>
</div>

<!-- ğŸ“– HISTORY -->
<div id="history" class="card hidden">
  <h2>×”×™×¡×˜×•×¨×™×”</h2>
  <input id="search" placeholder="×—×™×¤×•×©..." oninput="renderHistory()">
  <div id="list"></div>
  <div class="link" onclick="backToJournal()">â¬… ×—×–×¨×”</div>
</div>

<script>
const PREFIX="minute-";
const AUTH_KEY="webauthn-id";
const KEY_KEY="minute-key"; // ××§×¨××™ ××•×¦×¤×Ÿ
const PIN_KEY="minute-pin";
let cryptoKey=null;
const today=new Date().toISOString().slice(0,10);
document.getElementById("todayDate").textContent=
new Date().toLocaleDateString("he-IL",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

/* ---------------- CRYPTO ---------------- */
async function deriveKey(secret){ // PBKDF2
  const enc=new TextEncoder();
  const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(secret),"PBKDF2",false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt:enc.encode("minute-journal"),iterations:100000,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}

async function encrypt(text){
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const enc=new TextEncoder();
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},cryptoKey,enc.encode(text));
  return btoa(String.fromCharCode(...iv))+":"+btoa(String.fromCharCode(...new Uint8Array(ct)));
}

async function decrypt(cipher){
  const [iv64,ct64]=cipher.split(":");
  const iv=Uint8Array.from(atob(iv64),c=>c.charCodeAt(0));
  const ct=Uint8Array.from(atob(ct64),c=>c.charCodeAt(0));
  const plain=await crypto.subtle.decrypt({name:"AES-GCM",iv},cryptoKey,ct);
  return new TextDecoder().decode(plain);
}

async function generateRandomKey(){ // 256bit
  return crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"]);
}

async function exportCryptoKey(key){
  const raw=await crypto.subtle.exportKey("raw",key);
  return btoa(String.fromCharCode(...new Uint8Array(raw)));
}
async function importCryptoKey(str){
  const raw=Uint8Array.from(atob(str),c=>c.charCodeAt(0));
  return crypto.subtle.importKey("raw",raw,{name:"AES-GCM"},true,["encrypt","decrypt"]);
}

/* ---------------- BIOMETRIC ---------------- */
async function authenticateBiometric(){
  if(!window.PublicKeyCredential){ alert("×œ× ×ª×•××š ×‘×™×•××˜×¨×™"); return; }
  try{
    if(!localStorage.getItem(AUTH_KEY)){
      const cred=await navigator.credentials.create({publicKey:{
        challenge:crypto.getRandomValues(new Uint8Array(32)),
        rp:{name:"Minute Journal"},
        user:{id:crypto.getRandomValues(new Uint8Array(16)),name:"user",displayName:"User"},
        pubKeyCredParams:[{type:"public-key",alg:-7}],
        authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required"},
        timeout:60000
      }});
      localStorage.setItem(AUTH_KEY,btoa(String.fromCharCode(...new Uint8Array(cred.rawId))));
      const key=await generateRandomKey();
      cryptoKey=key;
      localStorage.setItem(KEY_KEY,await exportCryptoKey(key));
    } else {
      const rawId=Uint8Array.from(atob(localStorage.getItem(AUTH_KEY)),c=>c.charCodeAt(0));
      await navigator.credentials.get({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),allowCredentials:[{id:rawId,type:"public-key"}],userVerification:"required",timeout:60000}});
      cryptoKey=await importCryptoKey(localStorage.getItem(KEY_KEY));
    }
    await loadEntry();
    show("journal");
  } catch(e){ alert("×›×©×œ ×‘×™×•××˜×¨×™, ×”×©×ª××© ×‘-PIN"); }
}

/* ---------------- FALLBACK PIN ---------------- */
async function fallbackPin(){
  const pin=document.getElementById("pinInput").value;
  if(!pin || !localStorage.getItem(PIN_KEY)){ alert("PIN ×œ× ×ª×§×™×Ÿ"); return; }
  const key=await deriveKey(pin);
  cryptoKey=key;
  try{ await loadEntry(); show("journal"); }
  catch(e){ alert("×›× ×™×¡×” × ×›×©×œ×”, PIN ×©×’×•×™ ××• ×ª×•×›×Ÿ ×¤×’×•×"); }
}

/* ---------------- JOURNAL ---------------- */
async function loadEntry(){
  const stored=localStorage.getItem(PREFIX+today);
  if(stored) document.getElementById("entry").value=await decrypt(stored);
  else document.getElementById("entry").value="";
}

async function saveEntry(){
  const text=document.getElementById("entry").value;
  const enc=await encrypt(text);
  localStorage.setItem(PREFIX+today,enc);
  alert("× ×©××¨ âœ“");
}

function lockApp(){ show("lock"); }

/* ---------------- HISTORY ---------------- */
function openHistory(){ renderHistory(); show("history"); }
async function renderHistory(){
  const q=document.getElementById("search").value.toLowerCase();
  const list=document.getElementById("list");
  list.innerHTML="";
  const keys=Object.keys(localStorage).filter(k=>k.startsWith(PREFIX)).sort().reverse();
  for(const k of keys){
    try{
      const text=await decrypt(localStorage.getItem(k));
      if(!text.toLowerCase().includes(q)) continue;
      const div=document.createElement("div"); div.className="entry";
      div.innerHTML=`<div class="date">${k.replace(PREFIX,"")}</div><div>${text}</div>`;
      list.appendChild(div);
    }catch(e){ continue; }
  }
}

function backToJournal(){ show("journal"); }

/* ---------------- EXPORT / IMPORT ---------------- */
async function exportJournal(){
  const data={};
  for(const k of Object.keys(localStorage).filter(k=>k.startsWith(PREFIX))){
    data[k]=localStorage.getItem(k);
  }
  const blob=new Blob([JSON.stringify(data, null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="minute_journal.json";
  a.click();
}

function importJournal(event){
  const file=event.target.files[0];
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const data=JSON.parse(e.target.result);
      for(const k in data) localStorage.setItem(k,data[k]);
      alert("×™×•××Ÿ ×™×•×‘× ×‘×”×¦×œ×—×”!");
    }catch(err){ alert("×©×’×™××” ×‘×™×™×‘×•×"); }
  }
  reader.readAsText(file);
}

/* ---------------- NAV ---------------- */
function show(id){ ["lock","journal","history"].forEach(x=>document.getElementById(x).classList.add("hidden")); document.getElementById(id).classList.remove("hidden"); }
</script>
</body>
</html>